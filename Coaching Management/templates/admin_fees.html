{% extends 'base.html' %}
{% block content %}

<!-- ================= PAGE HEADER ================= -->
<div class="p-4 mb-4 rounded-4 text-white"
     style="background:linear-gradient(135deg,#4e73df,#1cc88a)">
    <h4 class="fw-bold mb-1">
        <i class="fa-solid fa-indian-rupee-sign me-2"></i>
        Fees Report
    </h4>
    <small class="opacity-75">
        Search, filter & review student fee payments
    </small>
</div>

<!-- ================= FILTER SECTION ================= -->
<div class="card border-0 shadow-sm rounded-4 mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3 align-items-end">

            <!-- Search by Name -->
            <div class="col-md-4">
                <label class="form-label fw-semibold">Search by Student Name</label>
                <input type="text" name="search"
                       value="{{ request.args.get('search','') }}"
                       class="form-control"
                       placeholder="Enter student name">
            </div>

            <!-- Filter by Class -->
            <div class="col-md-3">
                <label class="form-label fw-semibold">Filter by Class</label>
                <select name="class" class="form-select">
                    <option value="">All Classes</option>
                    {% for i in range(1, 11) %}
                        <option value="{{ i }}"
                          {% if request.args.get('class') == i|string %}selected{% endif %}>
                          Class {{ i }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Filter by Status -->
            <div class="col-md-3">
                <label class="form-label fw-semibold">Payment Status</label>
                <select name="status" class="form-select">
                    <option value="">All</option>
                    <option value="Paid"
                      {% if request.args.get('status') == 'Paid' %}selected{% endif %}>
                      Paid
                    </option>
                    <option value="Unpaid"
                      {% if request.args.get('status') == 'Unpaid' %}selected{% endif %}>
                      Unpaid
                    </option>
                </select>
            </div>

            <!-- Buttons -->
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100 mb-2">
                    <i class="fa-solid fa-filter me-1"></i> Apply
                </button>
                <a href="{{ url_for('admin_fees_report') }}"
                   class="btn btn-outline-secondary w-100">
                   Reset
                </a>
            </div>

        </form>
    </div>
</div>

<!-- ================= SUMMARY CARDS ================= -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card border-0 shadow-sm rounded-4 text-center">
            <div class="card-body">
                <h6 class="text-muted">Total Records</h6>
                <h3 class="fw-bold">{{ data|length }}</h3>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card border-0 shadow-sm rounded-4 text-center">
            <div class="card-body">
                <h6 class="text-muted">Paid</h6>
                <h3 class="fw-bold text-success">
                    {{ data | selectattr('status','equalto','Paid') | list | length }}
                </h3>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card border-0 shadow-sm rounded-4 text-center">
            <div class="card-body">
                <h6 class="text-muted">Unpaid</h6>
                <h3 class="fw-bold text-danger">
                    {{ data | selectattr('status','equalto','Unpaid') | list | length }}
                </h3>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card border-0 shadow-sm rounded-4 text-center">
            <div class="card-body">
                <h6 class="text-muted">Total Collection</h6>
                <h3 class="fw-bold text-primary">
                    ₹ {{ total_collection }}
                </h3>
            </div>
        </div>
    </div>
</div>

<!-- ================= FEES TABLE ================= -->
<div class="card border-0 shadow rounded-4">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Student</th>
                        <th>Class</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Payment Date</th>
                        <th>Action</th>
                    </tr>
                </thead>

                <tbody>
                {% for row in data %}
                <tr>
                    <td class="fw-semibold">{{ row.name }}</td>

                    <td>
                        <span class="badge bg-primary bg-opacity-10 text-primary">
                            Class {{ row.class }}
                        </span>
                    </td>

                    <td class="fw-semibold">₹ {{ row.amount }}</td>

                    <td>
                        {% if row.status == 'Paid' %}
                            <span class="badge bg-success bg-opacity-10 text-success">Paid</span>
                        {% else %}
                            <span class="badge bg-danger bg-opacity-10 text-danger">Unpaid</span>
                        {% endif %}
                    </td>

                    <td>{{ row.date or "—" }}</td>

                    <td>
                        {% if row.status == 'Unpaid' %}
                        <form method="POST"
                              action="{{ url_for('admin_pay_fee', student_id=row.student_id) }}"
                              onsubmit="return confirm('Confirm payment received?')">
                            <button class="btn btn-sm btn-success">
                                <i class="fa-solid fa-check me-1"></i> Pay
                            </button>
                        </form>
                        {% else %}
                            <span class="text-muted">Paid</span>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        No fee records found
                    </td>
                </tr>
                {% endfor %}
                </tbody>

            </table>
        </div>
    </div>
</div>

{% endblock %}
